<!DOCTYPE html>
<html>

	<head>
		<!-- Standard Meta -->
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<link rel="shortcut icon" type="image/png" href="assets/images/fav.png"/>
		<!-- Site Properties -->
		<title>Probe Sentez Detayı</title>

  		<link rel="stylesheet" href="./jquery/jquery-plugins/css/jquery-ui.css">
		<link rel="stylesheet" href="./semanticui/semantic.min.css">
		<link rel="stylesheet" href="./datatables/datatables.min.css">
		<link rel="stylesheet" type="text/css" href="css/general.css">
		
		<script src="./jquery/jquery-3.3.1.js"></script>
		<script src="./jquery/jquery-plugins/js/jquery-ui.js"></script>
		<script src="./jquery/jquery-plugins/js/jquery.cookie-1.4.1.js"></script>
		<script src="./semanticui/semantic.min.js"></script>
		<script src="./datatables/datatables.min.js"></script>

		<script src="./js/moment-with-locales.js"></script>
		<script src="./datatables/datetime.js"></script>
		<script src="./datatables/widgetbase.js"></script>

		<script src="./js-xlsx/xlsx.full.min.js"></script>
		<script src="./js/FileSaver.js"></script>

		<script src="acm/acm-ui-auth.js"></script>
		<script src="acm/acm-data-handler.js"></script>
		<script src="acm/acm-page-handler.js"></script>
		<script src="acm/acm-dialog.js"></script>
		<script src="acm/acm-form.js"></script>
		<script src="acm/acm-input.js"></script>
		<script src="acm/acm-textarea.js"></script>
		<script src="acm/acm-table.js"></script>
		<script src="acm/acm-container.js"></script>
		<script src="acm/acm-img.js"></script>
		<script src="acm/acm-link.js"></script>
		<script src="acm/acm-dropdown.js"></script>
		<script src="acm/acm-cbox.js"></script>
		<script src="acm/acm-list.js"></script>
		<script src="acm/acm-modal.js"></script>
		<script src="acm/acm-xlsx.js"></script>
		<style>
			.content.container {
				margin-top:100px;
			}
			.ui.fullscreen.modal {
				position: static !important;
			}
			.redbp {
				background-color: #f1d7d7;
				color: #9f3a38;
			}
			div.absolute {
				position: absolute;
				top: 350px;
				left: 10px;
				right: 10px;
			}
			.fixeddiv{
				position: fixed !important;
				float: left;
				width: inherit;
				margin-top: 4em;
			}
			.sep{
				margin-bottom: 10px;
			}
		</style>
	</head>

	<body>
  
		<acmus id="navbarcontainer"></acmus>
		<acmus id="dialogcontainer"></acmus>

	<div class="ui grid">

		<div class="two wide column content container">
			<div class="fixeddiv">
				<div class="ui card">
					<div class="content">
						<div class="header">Probelar:</div>
					</div>
					<div class="content">
						<div class="ui small feed">
							<div class="event">
								<div class="content">
									<div class="summary">
										 <p><strong>Toplam:</strong><span id="total">0</span></p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="thirteen wide column">
			<div class="ui vertically divided grid content container">

				<div class="row">
					<div class="ui large header">
						<i class="history icon"></i>
						<div class="content">
							Probe Sentez Listesi
						</div>
					</div>
				</div>
				<div class="row">
					<div id="synthlisttable"></div>
				</div>
				<div class="row">
					<div id="button_container" class="eight wide column"></div>
					<div id="button2_container" class="eight wide column"></div>
				</div>
			</div>
		</div>
	</div>

	</body>

	<script>

		$(document).on("pagecreated",function(){

			$.getWidget('synthlisttable').datatable.on( 'draw.dt', function () {
				$("#total").html($.getWidget('synthlisttable').datatable.page.info().recordsTotal);
			});

			// Place buttons to containers
			$.getWidget('synthlisttable').table.DataTable().buttons(0, null).container().appendTo($('div.eight.column:eq(0)',$.getWidget('synthlisttable').table.DataTable().table().container()));

			$("#control_group").click(function(){
				$.getWidget('modal').show();
			});
			
			$("#remove_row").click(function(){
			
				contolprimerids = [];
				orderprimerids = [];
				
				$.getWidget("synthlisttable").datatable.rows( { selected: true } ).every(function(){
					if (this.data().orderid != null && this.data().orderid != 0) {
						orderprimerids.push(this.index());
					} else {
						contolprimerids.push(this.index());
					}
				});
				
				if(contolprimerids.length) {
					var edi2 =$.getWidget("synthlisttable").editor.remove($.getWidget("synthlisttable").datatable.rows(contolprimerids).indexes(),false);
					edi2.submit(function(x){
						console.log("ok");
						//remove rows
					}, function() {
						console.log("not ok");
						//handle error
					});
				}

				if(orderprimerids.length) {
					var edi =$.getWidget("synthlisttable").editor.edit($.getWidget("synthlisttable").datatable.rows(orderprimerids).indexes(),false)
					edi.set("synthid","null").submit(function(){
						//$.getWidget("synthlisttable").datatable.rows( orderprimerids ).remove().draw();
						console.log("ok");
						//remove rows
					}, function() {
						console.log("not ok");
						//handle error
					});
				}
				

				/*
				$.getWidget("synthlisttable").datatable.rows( { selected: true } ).every(function(){
					if (this.data().orderid == 0 || this.data().orderid == null) {
						contolprimerids.push(this.index());
					}
				});
				*/
			});
				
			$("#approvebutton").click(function(){
				var data = $.getWidget("modaltable").datatable.rows( { selected: true } ).data();
				$.each(data, function(i,v) {
					var editor = $.getWidget("synthlisttable").editor.create(false);
					editor.set("name",v.name)
					.set("sequence",v.sequence)
					.set("probe_fifth.id",v["probe_fifth"] == null ? null : v["probe_fifth"].id)
					.set("probe_third.id", v["probe_third"] == null ? null : v["probe_third"].id)
					//.set("primer_puri.id",v["primer_puri"].id)
					//.set("primer_sca.id",v["primer_sca"].id)
					.set("synthid",0).set("orderid",0).set("userid",0)
					.submit();
				});
			});
			
			$(document).on("rowsdone",function(e, synthid){
				$.formAction({type:"probe", synthid:synthid}, "addsynthservice", function(data) {
					$.cookie("tempvarsynth",JSON.stringify({id:synthid}));
					window.location.href = "productionSynthesisProbe.html";
				});
				
			});
			
			$("#syntheses").click(function(){
				console.log("syntheses");
				$.formAction({type:"probe"}, "createsynthservice", function(data) {
					//console.log(data);
					var edi3 = $.getWidget("synthlisttable").editor;
					var tbl = $.getWidget("synthlisttable").datatable;
					
					var nextid = 1, rowcnt = tbl.rows().data().length, processedrowcnt = 0;
					
					var ordered = [];
					$.getWidget("synthlisttable").table.find('tbody').find('tr').each(function(i,r){
						ordered.push($(r).find('.row-order' ).val(i).prevObject[0]._DT_RowIndex);
					});

					tbl.rows(ordered).every( function ( rowIdx, tableLoop, rowLoop ) {
					
						var tdata = this.data();
						tdata["synthname"] = data.name + "-" + nextid;
						tdata["synthid"] = data.id;
						var mw = Number(tdata["sequence"].calculateMw().toFixed(2));
						if(tdata["probe_fifth"] != null) mw += Number(tdata["probe_fifth"]["mw"]);
						if(tdata["probe_third"] != null) mw += Number(tdata["probe_third"]["mw"]);
						tdata["mw"] = mw;
						//console.log(tdata["mw"]);
						tdata["gc"] = tdata["sequence"].calculateGc().toFixed(2);
						tdata["tmbasic"] = tdata["sequence"].calculateTm();
						var excoef = Number(tdata["sequence"].calculateEx());
						if(tdata["probe_fifth"] != null) excoef += Number(tdata["probe_fifth"]["e260"]);
						if(tdata["probe_third"] != null) excoef += Number(tdata["probe_third"]["e260"]);
						tdata["excoef"] = excoef;

						nextid++;
					});
					

					//$.getWidget("synthlisttable").datatable.rows().indexes() // <-- instead of ordered !!!
					edi3.edit(ordered, false).submit(function(x){
						console.log("synthnames ok");
						$(document).trigger("rowsdone", [data.id]);
					}, function() {
						console.log("synthnames not ok");
					});
	
				});
			});

			var nearest = {};
			nearest.A = {};
			nearest.C = {};
			nearest.G = {};
			nearest.T = {};
			nearest.I = {};
			nearest.A.A = 27400; nearest.A.C = 21200; nearest.A.G = 25000; nearest.A.T = 22800; nearest.A.I = 25400;
			nearest.C.A = 21200; nearest.C.C = 14600; nearest.C.G = 18000; nearest.C.T = 15200; nearest.C.I = 18600;
			nearest.G.A = 25200; nearest.G.C = 17600; nearest.G.G = 21600; nearest.G.T = 20000; nearest.G.I = 22600;
			nearest.T.A = 23400; nearest.T.C = 16200; nearest.T.G = 19000; nearest.T.T = 16800; nearest.T.I = 20600;
			nearest.I.A = 25400; nearest.I.C = 18600; nearest.I.G = 22400; nearest.I.T = 20600; nearest.I.I = 23000;
		
			function getnearest(t1,t2) {
				
				var t1arr = getBases(t1);
				var t2arr = getBases(t2);
				var res = 0;
				
				t1arr.forEach(function(e1){
					t2arr.forEach(function(e2){
						res += nearest[e1][e2];
					})
				})
			
				return res/(t1arr.length * t2arr.length); 
			}
			
			var indiv = {};
			indiv.A = 15400;
			indiv.C = 7400;
			indiv.G = 11500;
			indiv.T = 8700;
			indiv.I = 12350;
			
			function getindiv(t) {
				
				var res = 0;
				var tarr = getBases(t);
				tarr.forEach(function(e){
					res += indiv[e];
				})
				return res/tarr.length;
			}
			
			var dbases = {};
			dbases.R = ["A","G"];
			dbases.Y = ["C","T"];
			dbases.M = ["A","C"];
			dbases.K = ["G","T"];
			dbases.S = ["C","G"]; //
			dbases.W = ["A","T"]; //
			dbases.H = ["A","C","T"];
			dbases.B = ["C","G","T"];
			dbases.V = ["A","C","G"];
			dbases.D = ["A","G","T"];
			dbases.N = ["A","C","G","T"];
			dbases[" "] = [];
			
			function getBases(ct) {
				var c = ct.toUpperCase();
				if (c == "A" || c == "C" || c == "G" || c == "T" || c == "I" || c == "L") return [c];
				else return dbases[c];
			}
			var mws = {};
			mws.A = 313.21;
			mws.C = 289.18;
			mws.G = 329.21;
			mws.T = 304.2;
			mws.I = 314.19;
			function getmw(t) {

				var res = 0;
				var tarr = getBases(t);
				tarr.forEach(function(e){
					res += mws[e];
				})
				return res/tarr.length;
			}
			function getgc(t) {
				var res = 0;
				var tarr = getBases(t);
				tarr.forEach(function(e){
					if (e == "G" || e == "C") res += 1;
				})
				return res/tarr.length;
			}
			String.prototype.calculateEx = function() {
				var target = this;
				var excoef = 0;
				for (var i = 0;(i+1)<target.length;i++) {		
					excoef += getnearest(target[i],target[i+1]);
					if(i>0) excoef -= getindiv(target[i]);
				}
				return excoef;
			};
			String.prototype.calculateMw = function() {
				var target = this;
				var mw = 0;
				
				for (var i = 0;i<target.length;i++) {		
					mw += getmw(target[i]);
				}
			
				return mw - 61.96;
			};
			String.prototype.calculateGc = function() {
				var target = this;
				var gc = 0;
				
				for (var i = 0;i<target.length;i++) {		
					gc += getgc(target[i]);
				}
				
				return gc/target.length;
			};
			
			var TMlist = ["G","C","S"];
			var TMlistdegen = ["R","Y","M","K","H","B","V","D","N"];
			
			String.prototype.calculateTm = function() {
				var target = this;

				var tempchar = "";

				var mingc = 0;
				var maxgc = 0;


				for (var i = 0;i<target.length;i++) {
					tempchar = target[i].toUpperCase()
					if(TMlist.includes(tempchar)) {
						mingc++;
						maxgc++;
					} else if(TMlistdegen.includes(tempchar)) {
						mingc++;
					}
				}

				var tmmin = 0;
				var tmmax = 0;

				if(target.length > 13) {
					tmmax = 64.9 +41*(mingc-16.4)/(target.length);
					tmmin = 64.9 +41*(maxgc-16.4)/(target.length);
				} else {
					tmmax = (target.length-mingc) * 2 + (mingc) * 4;
					tmmin = (target.length-maxgc) * 2 + (maxgc) * 4
				}
				
				tmmin = tmmin.toFixed(2);
				tmmax = tmmax.toFixed(2);
				
				if (tmmin == tmmax) return tmmax + "°C";
				else return tmmin + "°C" + "-" + tmmax + "°C";
				
			};

		})
	</script>
<html>